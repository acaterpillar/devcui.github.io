<!doctype html><html lang=cn dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>关于微前端实现原理与ngx-planet(三) | 神奇宝贝大师的旅行日记</title>
<meta name=keywords content="angular">
<meta name=description content="Desc Text.">
<meta name=author content="cui">
<link rel=canonical href=https://canonical.url/to/page>
<meta name=google-site-verification content="blog">
<meta name=yandex-verification content="blog">
<meta name=msvalidate.01 content="blog">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<link rel=preload href=/images/favicon.png as=image>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://eiyouhe.com/images/favicon.png>
<link rel=icon type=image/png sizes=16x16 href=https://eiyouhe.com/images/favicon.png>
<link rel=icon type=image/png sizes=32x32 href=https://eiyouhe.com/images/favicon.png>
<link rel=apple-touch-icon href=https://eiyouhe.com/images/favicon.png>
<link rel=mask-icon href=https://eiyouhe.com/images/favicon.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.4">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-213464061-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="关于微前端实现原理与ngx-planet(三)">
<meta property="og:description" content="Desc Text.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://eiyouhe.com/posts/angular/ngxplanet3/"><meta property="og:image" content="https://eiyouhe.com/images/head.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-05T11:30:03+00:00">
<meta property="article:modified_time" content="2021-12-05T11:30:03+00:00"><meta property="og:site_name" content="神奇宝贝大师的旅行日记">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://eiyouhe.com/images/head.png">
<meta name=twitter:title content="关于微前端实现原理与ngx-planet(三)">
<meta name=twitter:description content="Desc Text.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://eiyouhe.com/posts/"},{"@type":"ListItem","position":3,"name":"关于微前端实现原理与ngx-planet(三)","item":"https://eiyouhe.com/posts/angular/ngxplanet3/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"关于微前端实现原理与ngx-planet(三)","name":"关于微前端实现原理与ngx-planet(三)","description":"Desc Text.","keywords":["angular"],"articleBody":"1.为什么要服务端渲染 因为公司后端服务在k8s上，是分布式的微服务，之前端全部打包部署在了物理机器(虚拟机)nginx上,如果通过helm做应用商店的话，nginx前端这部分无法处理，包括灰度部署，CI等，全部都只能做到接口级别的处理，并不能连带静态资源文件一起处理，所以基于分布式的前端整改迫在眉睫。\n偶然发现了ngx-planet，整篇文章基于前几篇文章，可以看之前的几篇文章。\n2.如何基于ngx-palnet进行服务端渲染 2.0 有路由前缀的情况下服务端渲染ngx-planet如何改进 在 start函数中监听路由阶段，其中的 startWith过滤路由要把 location.pathname修改好，要将前缀去除掉，至于如何动态去除不写死，仁者见仁智者见智。\n2.1 首先，准备打包好的静态文件 将 build命令修改，注意 --deploy-url的意思是，打包完成后，静态资源路径是什么\n1 2  \"build\": \"ng build --prod --deploy-url=/static/star-universe/ --base-href=/star-universe\",   打包后的index.html如图，静态资源路径变成了 /static/star-universe前缀，这里和 base-href不能冲突，否则在渲染时有死循环问题\n其次 base-href就是项目访问路径前缀\n然后修改 angular.json中的 build放到你的静态资源目录，这样在执行 npm run build后静态资源自动放入后台项目中的静态目录中\n2.2 准备Portal后台项目 我的项目基于SpringBoot自动生成，项目结构如下\n以下是用到的maven配置文件\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52    xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\" 4.0.0  org.springframework.boot spring-boot-starter-parent 2.4.3    com.yunzainfo.cloud star-universe 0.0.1-SNAPSHOT star-universe Demo project for Spring Boot  1.8    org.springframework.boot spring-boot-starter-web   org.springframework.boot spring-boot-starter   org.springframework.boot spring-boot-starter-thymeleaf   org.springframework.boot spring-boot-starter-test test      org.springframework.boot spring-boot-maven-plugin       一个Controller负责重定向路由到 index.html\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  package com.yunzainfo.cloud.staruniverse.web; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.RequestMapping; import org.springframework.web.servlet.ModelAndView; import javax.servlet.http.HttpServletRequest; @Controller public class StaticController { @RequestMapping(value = {\"/star-universe\", \"/star-universe/**\"}) public String index(HttpServletRequest request) { System.out.println(request.getRequestURI()); return \"index\"; } }   portal的静态资源处理，通过实现 WebMvcConfigurer的 addResourceHandlers函数,注意函数传参数的静态资源路径谓 /static/star-universe/**要和 --deploy-url对应起来，保证 index.html中的静态资源被正确加载\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  package com.yunzainfo.cloud.staruniverse.config; import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry; import org.springframework.web.servlet.config.annotation.WebMvcConfigurer; @Configuration public class WebMvcConfig implements WebMvcConfigurer { @Override public void addResourceHandlers(ResourceHandlerRegistry registry) { registry.addResourceHandler(\"/static/star-universe/**\").addResourceLocations(\"classpath:/static/\"); } }   然后是portal的applicaiton.yml，给一个端口吧，这里我选择的是3000,和proxy.config中的相同，至于静态资源路径为什么是 /static也是为了和注册应用时的路径保持一致\n1 2 3 4 5 6 7 8 9  server:port:3000spring:thymeleaf:cache:falseprefix:classpath:/static/  关于 app.component中的应用注册,resourcePathPrefix和 manifest全都加入应用路径完成远程注册\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  [ { \"name\": \"star-dust\", \"hostParent\": \"#wormhole\", \"hostClass\": \"star-dust\", \"routerPathPrefix\": \"/star-dust\", \"stylePrefix\": \"star-dust\", \"resourcePathPrefix\": \"http://localhost:3001/static/star-dust/\", \"loadSerial\": true, \"preload\": false, \"switchMode\": \"coexist\", \"scripts\": [ \"main.js\" ], \"styles\": [ \"styles.css\" ], \"manifest\": \"http://localhost:3001/static/star-dust/manifest.json\" } ]   2.3 准备子项目前台项目 同样修改 build和 angular.json 然后打包\n2.4 准备子项目后台项目 这里唯一和portal项目不同的时，要加入跨域访问允许，因为portal加载js/css的时候是远程加载的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  package com.yunzainfo.cloud.stardust.config; import org.springframework.context.annotation.Configuration; import org.springframework.web.servlet.config.annotation.*; @Configuration public class WebMvcConfig implements WebMvcConfigurer { @Override public void addResourceHandlers(ResourceHandlerRegistry registry) { registry.addResourceHandler(\"/static/star-dust/**\").addResourceLocations(\"classpath:/static/\"); } @Override public void addCorsMappings(CorsRegistry registry) { registry.addMapping(\"/**\") .allowCredentials(true) .allowedOrigins(\"http://localhost:3000\", \"http://localhost:3001\", \"http://localhost:3002\", \"http://localhost:3003\") .allowedMethods(\"POST\", \"GET\", \"PUT\", \"OPTIONS\", \"DELETE\") .maxAge(3600) .allowCredentials(true); } }   其余和portal一致，只是路径不一样\n3.看效果 这样，静态资源全都被远程请求过来了\n4.这种远程技术可以运用到什么地方 首先组件共享的好处不说了，结合了后端微服务的 真正的前端微服务而不是依托于 nginx静态部署的前端微服务\n可以优化开发流程，可以做灰度部署了，可以完善CI了等等，好处也有，坏处也有。有利有弊，看各自需要吧。\n","wordCount":"397","inLanguage":"cn","datePublished":"2021-12-05T11:30:03Z","dateModified":"2021-12-05T11:30:03Z","author":{"@type":"Person","name":"cui"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://eiyouhe.com/posts/angular/ngxplanet3/"},"publisher":{"@type":"Organization","name":"神奇宝贝大师的旅行日记","logo":{"@type":"ImageObject","url":"https://eiyouhe.com/images/favicon.png"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://eiyouhe.com accesskey=h title="  (Alt + H)">
<img src=/images/favicon.png alt=logo aria-label=logo height=35> </a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://eiyouhe.com/posts title=列表>
<span>列表</span>
</a>
</li>
<li>
<a href=https://eiyouhe.com/categories title=分类>
<span>分类</span>
</a>
</li>
<li>
<a href=https://eiyouhe.com/tags title=标签>
<span>标签</span>
</a>
</li>
<li>
<a href=https://eiyouhe.com/series title=系列>
<span>系列</span>
</a>
</li>
<li>
<a href=https://eiyouhe.com/archives title=归档>
<span>归档</span>
</a>
</li>
<li>
<a href=https://eiyouhe.com/resume title=冠军>
<span>冠军</span>
</a>
</li>
<li>
<a href=https://eiyouhe.com/psyduck title=救助可达鸭>
<span>救助可达鸭</span>
</a>
</li>
<li>
<a href=https://zukan.pokemon.co.jp/ title=已抓住图鉴>
<span>已抓住图鉴</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://eiyouhe.com>Home</a>&nbsp;»&nbsp;<a href=https://eiyouhe.com/posts/>Posts</a></div>
<h1 class=post-title>
关于微前端实现原理与ngx-planet(三)
</h1>
<div class=post-description>
Desc Text.
</div>
<div class=post-meta><span title="2021-12-05 11:30:03 +0000 UTC">December 5, 2021</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;cui&nbsp;|&nbsp;<a href=https://github.com/devcui/devcui.github.io/tree/master/content//posts/angular/ngxplanet3.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#1%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b8%b2%e6%9f%93 aria-label=1.为什么要服务端渲染>1.为什么要服务端渲染</a></li>
<li>
<a href=#2%e5%a6%82%e4%bd%95%e5%9f%ba%e4%ba%8engx-palnet%e8%bf%9b%e8%a1%8c%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b8%b2%e6%9f%93 aria-label=2.如何基于ngx-palnet进行服务端渲染>2.如何基于ngx-palnet进行服务端渲染</a><ul>
<li>
<a href=#20-%e6%9c%89%e8%b7%af%e7%94%b1%e5%89%8d%e7%bc%80%e7%9a%84%e6%83%85%e5%86%b5%e4%b8%8b%e6%9c%8d%e5%8a%a1%e7%ab%af%e6%b8%b2%e6%9f%93ngx-planet%e5%a6%82%e4%bd%95%e6%94%b9%e8%bf%9b aria-label="2.0 有路由前缀的情况下服务端渲染ngx-planet如何改进">2.0 有路由前缀的情况下服务端渲染ngx-planet如何改进</a></li>
<li>
<a href=#21-%e9%a6%96%e5%85%88%e5%87%86%e5%a4%87%e6%89%93%e5%8c%85%e5%a5%bd%e7%9a%84%e9%9d%99%e6%80%81%e6%96%87%e4%bb%b6 aria-label="2.1 首先，准备打包好的静态文件">2.1 首先，准备打包好的静态文件</a></li>
<li>
<a href=#22-%e5%87%86%e5%a4%87portal%e5%90%8e%e5%8f%b0%e9%a1%b9%e7%9b%ae aria-label="2.2 准备Portal后台项目">2.2 准备Portal后台项目</a></li>
<li>
<a href=#23-%e5%87%86%e5%a4%87%e5%ad%90%e9%a1%b9%e7%9b%ae%e5%89%8d%e5%8f%b0%e9%a1%b9%e7%9b%ae aria-label="2.3 准备子项目前台项目">2.3 准备子项目前台项目</a></li>
<li>
<a href=#24-%e5%87%86%e5%a4%87%e5%ad%90%e9%a1%b9%e7%9b%ae%e5%90%8e%e5%8f%b0%e9%a1%b9%e7%9b%ae aria-label="2.4 准备子项目后台项目">2.4 准备子项目后台项目</a></li></ul>
</li>
<li>
<a href=#3%e7%9c%8b%e6%95%88%e6%9e%9c aria-label=3.看效果>3.看效果</a></li>
<li>
<a href=#4%e8%bf%99%e7%a7%8d%e8%bf%9c%e7%a8%8b%e6%8a%80%e6%9c%af%e5%8f%af%e4%bb%a5%e8%bf%90%e7%94%a8%e5%88%b0%e4%bb%80%e4%b9%88%e5%9c%b0%e6%96%b9 aria-label=4.这种远程技术可以运用到什么地方>4.这种远程技术可以运用到什么地方</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h1 id=1为什么要服务端渲染>1.为什么要服务端渲染<a hidden class=anchor aria-hidden=true href=#1为什么要服务端渲染>#</a></h1>
<p>因为公司后端服务在k8s上，是分布式的微服务，之前端全部打包部署在了物理机器(虚拟机)nginx上,如果通过helm做应用商店的话，nginx前端这部分无法处理，包括灰度部署，CI等，全部都只能做到接口级别的处理，并不能连带静态资源文件一起处理，所以基于分布式的前端整改迫在眉睫。</p>
<p>偶然发现了ngx-planet，整篇文章基于前几篇文章，可以看之前的几篇文章。</p>
<h1 id=2如何基于ngx-palnet进行服务端渲染>2.如何基于ngx-palnet进行服务端渲染<a hidden class=anchor aria-hidden=true href=#2如何基于ngx-palnet进行服务端渲染>#</a></h1>
<h2 id=20-有路由前缀的情况下服务端渲染ngx-planet如何改进>2.0 有路由前缀的情况下服务端渲染ngx-planet如何改进<a hidden class=anchor aria-hidden=true href=#20-有路由前缀的情况下服务端渲染ngx-planet如何改进>#</a></h2>
<p><img loading=lazy src=https://b3logfile.com/file/2021/02/image-11f71cd7.png alt=image.png>
</p>
<p>在 <code>start</code>函数中监听路由阶段，其中的 <code>startWith</code>过滤路由要把 <code>location.pathname</code>修改好，要将前缀去除掉，至于如何动态去除不写死，仁者见仁智者见智。</p>
<h2 id=21-首先准备打包好的静态文件>2.1 首先，准备打包好的静态文件<a hidden class=anchor aria-hidden=true href=#21-首先准备打包好的静态文件>#</a></h2>
<p>将 <code>build</code>命令修改，注意 <code>--deploy-url</code>的意思是，打包完成后，静态资源路径是什么</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>    &#34;build&#34;: &#34;ng build --prod --deploy-url=/static/star-universe/ --base-href=/star-universe&#34;,

</code></pre></td></tr></table>
</div>
</div><p><img loading=lazy src=https://b3logfile.com/file/2021/02/image-2baa6815.png alt=image.png>
</p>
<p>打包后的index.html如图，静态资源路径变成了 <code>/static/star-universe</code>前缀，这里和 <code>base-href</code>不能冲突，否则在渲染时有死循环问题</p>
<p>其次 <code>base-href</code>就是项目访问路径前缀</p>
<p>然后修改 <code>angular.json</code>中的 <code>build</code>放到你的静态资源目录，这样在执行 <code>npm run build</code>后静态资源自动放入后台项目中的静态目录中</p>
<p><img loading=lazy src=https://b3logfile.com/file/2021/02/image-93ae712c.png alt=image.png>
</p>
<h2 id=22-准备portal后台项目>2.2 准备Portal后台项目<a hidden class=anchor aria-hidden=true href=#22-准备portal后台项目>#</a></h2>
<p>我的项目基于SpringBoot自动生成，项目结构如下</p>
<p><img loading=lazy src=https://b3logfile.com/file/2021/02/image-6996d199.png alt=image.png>
</p>
<p>以下是用到的maven配置文件</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class=nt>&lt;project</span> <span class=na>xmlns=</span><span class=s>&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class=na>xmlns:xsi=</span><span class=s>&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class=na>xsi:schemaLocation=</span><span class=s>&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class=nt>&gt;</span>
    <span class=nt>&lt;modelVersion&gt;</span>4.0.0<span class=nt>&lt;/modelVersion&gt;</span>
    <span class=nt>&lt;parent&gt;</span>
        <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
        <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-parent<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;version&gt;</span>2.4.3<span class=nt>&lt;/version&gt;</span>
        <span class=nt>&lt;relativePath/&gt;</span> <span class=c>&lt;!-- lookup parent from repository --&gt;</span>
    <span class=nt>&lt;/parent&gt;</span>
    <span class=nt>&lt;groupId&gt;</span>com.yunzainfo.cloud<span class=nt>&lt;/groupId&gt;</span>
    <span class=nt>&lt;artifactId&gt;</span>star-universe<span class=nt>&lt;/artifactId&gt;</span>
    <span class=nt>&lt;version&gt;</span>0.0.1-SNAPSHOT<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;name&gt;</span>star-universe<span class=nt>&lt;/name&gt;</span>
    <span class=nt>&lt;description&gt;</span>Demo project for Spring Boot<span class=nt>&lt;/description&gt;</span>
    <span class=nt>&lt;properties&gt;</span>
        <span class=nt>&lt;java.version&gt;</span>1.8<span class=nt>&lt;/java.version&gt;</span>
    <span class=nt>&lt;/properties&gt;</span>
    <span class=nt>&lt;dependencies&gt;</span>
        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-web<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>

        <span class=nt>&lt;dependency&gt;</span>
            <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
            <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-test<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;scope&gt;</span>test<span class=nt>&lt;/scope&gt;</span>
        <span class=nt>&lt;/dependency&gt;</span>
    <span class=nt>&lt;/dependencies&gt;</span>

    <span class=nt>&lt;build&gt;</span>
        <span class=nt>&lt;plugins&gt;</span>
            <span class=nt>&lt;plugin&gt;</span>
                <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
                <span class=nt>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class=nt>&lt;/artifactId&gt;</span>
            <span class=nt>&lt;/plugin&gt;</span>
        <span class=nt>&lt;/plugins&gt;</span>
    <span class=nt>&lt;/build&gt;</span>

<span class=nt>&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><p>一个Controller负责重定向路由到 <code>index.html</code></p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>com.yunzainfo.cloud.staruniverse.web</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.stereotype.Controller</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.bind.annotation.RequestMapping</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.servlet.ModelAndView</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>javax.servlet.http.HttpServletRequest</span><span class=o>;</span>

<span class=nd>@Controller</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>StaticController</span> <span class=o>{</span>

    <span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=o>{</span><span class=s>&#34;/star-universe&#34;</span><span class=o>,</span> <span class=s>&#34;/star-universe/**&#34;</span><span class=o>})</span>
    <span class=kd>public</span> <span class=n>String</span> <span class=nf>index</span><span class=o>(</span><span class=n>HttpServletRequest</span> <span class=n>request</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>request</span><span class=o>.</span><span class=na>getRequestURI</span><span class=o>());</span>
        <span class=k>return</span> <span class=s>&#34;index&#34;</span><span class=o>;</span>
    <span class=o>}</span>

<span class=o>}</span>

</code></pre></td></tr></table>
</div>
</div><p>portal的静态资源处理，通过实现 <code>WebMvcConfigurer</code>的 <code>addResourceHandlers</code>函数,注意函数传参数的静态资源路径谓 <code>/static/star-universe/**</code>要和 <code>--deploy-url</code>对应起来，保证 <code>index.html</code>中的静态资源被正确加载</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>com.yunzainfo.cloud.staruniverse.config</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Configuration</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.servlet.config.annotation.WebMvcConfigurer</span><span class=o>;</span>

<span class=nd>@Configuration</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>WebMvcConfig</span> <span class=kd>implements</span> <span class=n>WebMvcConfigurer</span> <span class=o>{</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addResourceHandlers</span><span class=o>(</span><span class=n>ResourceHandlerRegistry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>registry</span><span class=o>.</span><span class=na>addResourceHandler</span><span class=o>(</span><span class=s>&#34;/static/star-universe/**&#34;</span><span class=o>).</span><span class=na>addResourceLocations</span><span class=o>(</span><span class=s>&#34;classpath:/static/&#34;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>

</code></pre></td></tr></table>
</div>
</div><p>然后是portal的applicaiton.yml，给一个端口吧，这里我选择的是3000,和proxy.config中的相同，至于静态资源路径为什么是 <code>/static</code>也是为了和注册应用时的路径保持一致</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=nt>server</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>3000</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nt>spring</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>thymeleaf</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cache</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w>    </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>classpath:/static/</span><span class=w>
</span><span class=w>
</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>关于 <code>app.component</code>中的应用注册,<code>resourcePathPrefix</code>和 <code>manifest</code>全都加入应用路径完成远程注册</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>[</span>
  <span class=p>{</span>
    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;star-dust&#34;</span><span class=p>,</span>
    <span class=nt>&#34;hostParent&#34;</span><span class=p>:</span> <span class=s2>&#34;#wormhole&#34;</span><span class=p>,</span>
    <span class=nt>&#34;hostClass&#34;</span><span class=p>:</span> <span class=s2>&#34;star-dust&#34;</span><span class=p>,</span>
    <span class=nt>&#34;routerPathPrefix&#34;</span><span class=p>:</span> <span class=s2>&#34;/star-dust&#34;</span><span class=p>,</span>
    <span class=nt>&#34;stylePrefix&#34;</span><span class=p>:</span> <span class=s2>&#34;star-dust&#34;</span><span class=p>,</span>
    <span class=nt>&#34;resourcePathPrefix&#34;</span><span class=p>:</span> <span class=s2>&#34;http://localhost:3001/static/star-dust/&#34;</span><span class=p>,</span>
    <span class=nt>&#34;loadSerial&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
    <span class=nt>&#34;preload&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
    <span class=nt>&#34;switchMode&#34;</span><span class=p>:</span> <span class=s2>&#34;coexist&#34;</span><span class=p>,</span>
    <span class=nt>&#34;scripts&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;main.js&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;styles&#34;</span><span class=p>:</span> <span class=p>[</span>
      <span class=s2>&#34;styles.css&#34;</span>
    <span class=p>],</span>
    <span class=nt>&#34;manifest&#34;</span><span class=p>:</span> <span class=s2>&#34;http://localhost:3001/static/star-dust/manifest.json&#34;</span>
  <span class=p>}</span>
<span class=p>]</span>

</code></pre></td></tr></table>
</div>
</div><h2 id=23-准备子项目前台项目>2.3 准备子项目前台项目<a hidden class=anchor aria-hidden=true href=#23-准备子项目前台项目>#</a></h2>
<p>同样修改 <code>build</code>和 <code>angular.json</code> 然后打包</p>
<h2 id=24-准备子项目后台项目>2.4 准备子项目后台项目<a hidden class=anchor aria-hidden=true href=#24-准备子项目后台项目>#</a></h2>
<p>这里唯一和portal项目不同的时，要加入跨域访问允许，因为portal加载js/css的时候是远程加载的。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kn>package</span> <span class=nn>com.yunzainfo.cloud.stardust.config</span><span class=o>;</span>

<span class=kn>import</span> <span class=nn>org.springframework.context.annotation.Configuration</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.springframework.web.servlet.config.annotation.*</span><span class=o>;</span>

<span class=nd>@Configuration</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>WebMvcConfig</span> <span class=kd>implements</span> <span class=n>WebMvcConfigurer</span> <span class=o>{</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addResourceHandlers</span><span class=o>(</span><span class=n>ResourceHandlerRegistry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>registry</span><span class=o>.</span><span class=na>addResourceHandler</span><span class=o>(</span><span class=s>&#34;/static/star-dust/**&#34;</span><span class=o>).</span><span class=na>addResourceLocations</span><span class=o>(</span><span class=s>&#34;classpath:/static/&#34;</span><span class=o>);</span>
    <span class=o>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addCorsMappings</span><span class=o>(</span><span class=n>CorsRegistry</span> <span class=n>registry</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>registry</span><span class=o>.</span><span class=na>addMapping</span><span class=o>(</span><span class=s>&#34;/**&#34;</span><span class=o>)</span>
                <span class=o>.</span><span class=na>allowCredentials</span><span class=o>(</span><span class=kc>true</span><span class=o>)</span>
                <span class=o>.</span><span class=na>allowedOrigins</span><span class=o>(</span><span class=s>&#34;http://localhost:3000&#34;</span><span class=o>,</span> <span class=s>&#34;http://localhost:3001&#34;</span><span class=o>,</span> <span class=s>&#34;http://localhost:3002&#34;</span><span class=o>,</span> <span class=s>&#34;http://localhost:3003&#34;</span><span class=o>)</span>
                <span class=o>.</span><span class=na>allowedMethods</span><span class=o>(</span><span class=s>&#34;POST&#34;</span><span class=o>,</span> <span class=s>&#34;GET&#34;</span><span class=o>,</span> <span class=s>&#34;PUT&#34;</span><span class=o>,</span> <span class=s>&#34;OPTIONS&#34;</span><span class=o>,</span> <span class=s>&#34;DELETE&#34;</span><span class=o>)</span>
                <span class=o>.</span><span class=na>maxAge</span><span class=o>(</span><span class=n>3600</span><span class=o>)</span>
                <span class=o>.</span><span class=na>allowCredentials</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>

    <span class=o>}</span>
<span class=o>}</span>

</code></pre></td></tr></table>
</div>
</div><p>其余和portal一致，只是路径不一样</p>
<h1 id=3看效果>3.看效果<a hidden class=anchor aria-hidden=true href=#3看效果>#</a></h1>
<p><img loading=lazy src=https://b3logfile.com/file/2021/02/image-5da8d240.png alt=image.png>
</p>
<p><img loading=lazy src=https://b3logfile.com/file/2021/02/image-10f2850a.png alt=image.png>
</p>
<p>这样，静态资源全都被远程请求过来了</p>
<h1 id=4这种远程技术可以运用到什么地方>4.这种远程技术可以运用到什么地方<a hidden class=anchor aria-hidden=true href=#4这种远程技术可以运用到什么地方>#</a></h1>
<p>首先组件共享的好处不说了，结合了后端微服务的 <code>真正的</code>前端微服务而不是依托于 <code>nginx</code>静态部署的前端微服务</p>
<p>可以优化开发流程，可以做灰度部署了，可以完善CI了等等，好处也有，坏处也有。有利有弊，看各自需要吧。</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://eiyouhe.com/tags/angular/>angular</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://eiyouhe.com/posts/angular/ngxplanet2/>
<span class=title>« </span>
<br>
<span>关于微前端实现原理与ngx-planet(二)</span>
</a>
<a class=next href=https://eiyouhe.com/posts/angular/ngxplanet4/>
<span class=title> »</span>
<br>
<span>关于微前端实现原理与ngx-planet(四)</span>
</a>
</nav>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://eiyouhe.com>神奇宝贝大师的旅行日记</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>